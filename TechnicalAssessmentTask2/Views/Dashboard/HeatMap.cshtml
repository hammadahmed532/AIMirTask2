@model TechnicalAssessmentTask2.Models.HeatMapViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Heatmap View";
    var heatmapService = new TechnicalAssessmentTask2.Service.CommonUtility();
}

<style>
    .heatmap-container {
        width: 100%;
        background: #fff;
        border-radius: 12px;
        padding: 16px;
    }

    .heatmap-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 8px;
        font-family: "Segoe UI", sans-serif;
    }

        .heatmap-table th {
            text-align: center;
            font-weight: 600;
            color: #444;
        }

        .heatmap-table td {
            text-align: center;
            padding: 14px;
            border-radius: 8px;
            font-weight: 600;
            color: #fff;
        }

    .driver-cell {
        text-align: left !important;
        font-weight: 600;
        color: #444 !important;
        background: transparent !important;
    }

    .heatmap-table th:first-child,
    .heatmap-table td.driver-cell {
        width: 180px; /* adjust as needed */
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Top Correlated Drivers card styling */
    .top-driver-card {
        border-radius: 12px;
        border: 1px solid rgba(124,58,237,0.10);
        background: linear-gradient(180deg, #ffffff, #fbfbff);
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06), 0 2px 8px rgba(15, 23, 42, 0.04);
        padding: 14px;
        transition: transform .18s ease, box-shadow .18s ease;
    }

        .top-driver-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.10), 0 4px 12px rgba(15, 23, 42, 0.06);
        }

        .top-driver-card h6 {
            margin-bottom: 0.5rem;
        }

        .top-driver-card p {
            margin-bottom: 0.75rem;
        }

        .top-driver-card .list-unstyled {
            margin-bottom: 0;
        }

        /* enforce badge color used in the template */
        .top-driver-card .badge {
            background-color: #7c3aed !important;
            border-color: #7c3aed !important;
            color: #fff;
        }

    /* small fade used when replacing lists */
    .list-replace {
        transition: opacity 180ms ease;
    }

    .list-hidden {
        opacity: 0;
    }

    .driver-item-name {
        color: #2b2b2b;
    }

    .driver-item-row {
        padding: 6px 0;
        border-bottom: 1px dashed rgba(0,0,0,0.04);
    }
</style>
<div class="container-fluid px-4 py-3">
    <!-- Page Title -->
    <h2 class="mb-4 fw-bold">Heatmap View</h2>

    <!-- Filters -->
    <form method="post" action="@Url.Action("Filter", "Dashboard")">

        <div class="card p-3 mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md">
                    <label class="form-label small text-muted mb-1">Location</label>
                    <select class="form-select form-select-sm" name="location" id="locationFilter">
                        <option value="">All Locations</option>
                        @foreach (var location in Model.Locations)
                        {
                            <option value="@location">@location</option>
                        }
                    </select>
                </div>
                <div class="col-md">
                    <label class="form-label small text-muted mb-1">Department</label>
                    <select class="form-select form-select-sm" name="department" id="departmentFilter">
                        <option value="">All Departments</option>
                        @foreach (var department in Model.Departments)
                        {
                            <option value="@department">@department</option>
                        }
                    </select>
                </div>
                <div class="col-md">
                    <label class="form-label small text-muted mb-1">Gender</label>
                    <select class="form-select form-select-sm" name="Gender" id="GenderFilter">
                        <option value="">All Gender</option>
                        @foreach (var gender in Model.Genders)
                        {
                            <option value="@gender">@gender</option>
                        }
                    </select>
                </div>
                <div class="col-md">
                    <label class="form-label small text-muted mb-1">Tenure</label>
                    <select class="form-select form-select-sm" name="Tenure" id="TenuresFilter">
                        <option value="">All Tenure</option>
                        @foreach (var tenure in Model.Tenures)
                        {
                            <option value="@tenure.Value">@tenure.Text</option>
                        }
                    </select>
                </div>
                <div class="col-md">
                    <label class="form-label small text-muted mb-1">Age</label>
                    <select class="form-select form-select-sm" name="Age" id="AgesFilter">
                        <option value="">All Ages</option>
                        @foreach (var age in Model.Ages)
                        {
                            <option value="@age.Value">@age.Text</option>
                        }
                    </select>
                </div>
                <div class="col-md-auto d-flex gap-2">
                    <button class="btn btn-primary px-4" type="submit" style="background-color: #7c3aed; border-color: #7c3aed;">Apply Filters</button>
                    <button class="btn btn-outline-secondary">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </form>

    <div class="row g-4">
        <!-- Main Heatmap -->
        <div class="col-lg-8">
            <div class="card p-4">
                <h6 class="fw-semibold mb-2">Engagement Driver Correlations</h6>
                <p class="small text-muted mb-4">Visualizing the strength and direction of relationships between engagement drivers and outcome drivers.</p>
                <div id="myDiv"></div>
                <div class="table-responsive">

                    <div class="heatmap-container">
                        <table class="heatmap-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Discretionary Effort</th>
                                    <th>Intent to Stay</th>
                                    <th>Advocacy</th>
                                </tr>
                            </thead>
                            <tbody id="heatmap-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Correlation Strength Legend -->
                <div class="mt-4">
                    <h6 class="small fw-semibold mb-2">Correlation Strength Legend</h6>
                    <div class="d-flex flex-wrap gap-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="legend-box strong-positive"></div>
                            <span class="small">Strong Positive</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="legend-box moderate-positive"></div>
                            <span class="small">Moderate Positive</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="legend-box weak-positive"></div>
                            <span class="small">Weak Positive</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="legend-box neutral"></div>
                            <span class="small">Neutral</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="legend-box weak-negative"></div>
                            <span class="small">Weak Negative</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="legend-box moderate-negative"></div>
                            <span class="small">Moderate Negative</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="legend-box strong-negative"></div>
                            <span class="small">Strong Negative</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Correlated Drivers Sidebar -->
        <div class="col-lg-4">
            <div class="card p-4">
                <h6 class="fw-semibold mb-4">Top Correlated Drivers</h6>

                <div id="top-discretionary" class="mb-4 top-driver-card">
                    <h6 class="small fw-semibold mb-2"><span class="fa fa-line-chart"></span>  Discretionary Effort</h6>
                    <p class="small text-muted mb-3">Drivers with the strongest impact.</p>
                    <ul id="list-discretionary" class="list-unstyled list-replace">
                        @foreach (var item in Model.TopDiscretionaryEffortDrivers)
                        {
                            <li class="mb-2 d-flex justify-content-between align-items-center driver-item-row">
                                <span class="driver-item-name">@item.Driver</span>
                                <span class="badge bg-primary">@item.Correlation.ToString("+0.00;-0.00")</span>
                            </li>
                        }
                    </ul>
                </div>

                <div id="top-intent" class="mb-4 top-driver-card">
                    <h6 class="small fw-semibold mb-2"> <span class="fa fa-heart"></span> Intent to Stay</h6>
                    <p class="small text-muted mb-3">Drivers with the strongest impact.</p>
                    <ul id="list-intent" class="list-unstyled list-replace">
                        @foreach (var item in Model.TopIntentToStayDrivers)
                        {
                            <li class="mb-2 d-flex justify-content-between align-items-center driver-item-row">
                                <span class="driver-item-name">@item.Driver</span>
                                <span class="badge bg-primary">@item.Correlation.ToString("+0.00;-0.00")</span>
                            </li>
                        }
                    </ul>
                </div>

                <div id="top-advocacy" class="mb-4 top-driver-card">
                    <h6 class="small fw-semibold mb-2"><i class="fa fa-bar-chart" aria-hidden="true"></i> Advocacy</h6>
                    <p class="small text-muted mb-3">Drivers with the strongest impact.</p>
                    <ul id="list-advocacy" class="list-unstyled list-replace">
                        @foreach (var item in Model.TopAdvocacy)
                        {
                            <li class="mb-2 d-flex justify-content-between align-items-center driver-item-row">
                                <span class="driver-item-name">@item.Driver</span>
                                <span class="badge bg-primary">@item.Correlation.ToString("+0.00;-0.00")</span>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script type="text/javascript">
        // initial data rendered on server
        const heatmapData = @Html.Raw(Json.Serialize(Model.CorrelationData));

        function getHeatColor(value) {
            const abs = Math.abs(value);

            if (value >= 0) {
                if (abs > 0.8) return "#6f79e8";   // strong positive (blue)
                if (abs > 0.5) return "#9da3f0";
                if (abs > 0.2) return "#d6d9fb";
                return "#f2f3fd";
            } else {
                if (abs > 0.8) return "#e24b4b";   // strong negative (red)
                if (abs > 0.5) return "#f08a8a";
                if (abs > 0.2) return "#f6c1c1";
                return "#fdecec";
            }
        }

        const tbody = document.getElementById("heatmap-body");

        // render helper - re-uses same markup as initial render
        function renderHeatmapTable(data) {
            tbody.innerHTML = '';
            if (!Array.isArray(data) || data.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td class="driver-cell" colspan="4">No data available for the selected filters.</td>';
                tbody.appendChild(tr);
                return;
            }

            data.forEach(row => {
                const tr = document.createElement("tr");
                // guard numeric values and provide fallback
                const disc = (typeof row.discretionaryEffort === 'number') ? row.discretionaryEffort : parseFloat(row.discretionaryEffort) || 0;
                const stay = (typeof row.intentToStay === 'number') ? row.intentToStay : parseFloat(row.intentToStay) || 0;
                const adv = (typeof row.advocacy === 'number') ? row.advocacy : parseFloat(row.advocacy) || 0;

                tr.innerHTML = `
                  <td class="driver-cell">${row.driver}</td>
                  <td style="background:${getHeatColor(disc)}">${disc.toFixed(2)}</td>
                  <td style="background:${getHeatColor(stay)}">${stay.toFixed(2)}</td>
                  <td style="background:${getHeatColor(adv)}">${adv.toFixed(2)}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        function renderTopList(containerId, items) {
            const ul = document.getElementById(containerId);
            if (!ul) return;

            // simple fade-out / replace / fade-in
            ul.classList.add('list-hidden');

            setTimeout(() => {
                ul.innerHTML = '';
                if (!Array.isArray(items) || items.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'mb-2 driver-item-row';
                    li.innerHTML = '<span class="driver-item-name">No drivers</span>';
                    ul.appendChild(li);
                } else {
                    items.forEach(it => {
                        const li = document.createElement('li');
                        li.className = 'mb-2 d-flex justify-content-between align-items-center driver-item-row';
                        const driverName = it.Driver || it.driver || '';
                        const correlation = (typeof it.Correlation === 'number') ? it.Correlation : (it.correlation || 0);
                        li.innerHTML = `<span class="driver-item-name">${driverName}</span>
                                        <span class="badge">${(Number(correlation) || 0).toFixed(2)}</span>`;
                        ul.appendChild(li);
                    });
                }
                // reveal
                ul.classList.remove('list-hidden');
            }, 180);
        }

        // render initial table
        renderHeatmapTable(heatmapData);

        // Optionally expose a helper to update top driver cards from a model
        function updateTopDriverCards(model) {
            // model may be camelCase or PascalCase depending on server serializer
            const topDis = model.topDiscretionaryEffortDrivers || model.TopDiscretionaryEffortDrivers || model.TopDiscretionaryEffort || [];
            const topIntent = model.topIntentToStayDrivers || model.TopIntentToStayDrivers || model.TopIntentToStay || [];
            const topAdv = model.topAdvocacy || model.TopAdvocacy || [];

            renderTopList('list-discretionary', topDis);
            renderTopList('list-intent', topIntent);
            renderTopList('list-advocacy', topAdv);
        }

        // intercept filter form submit and perform AJAX
        (function attachFilterHandler() {
            // select the filter form on the page (first form or the one that targets "Filter")
            const filterForm = document.querySelector('form[action*="Filter"]') || document.querySelector('form');
            if (!filterForm) return;

            const submitBtn = filterForm.querySelector('button[type="submit"]');

            filterForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                if (submitBtn) submitBtn.disabled = true;

                const location = document.getElementById('locationFilter')?.value || '';
                const department = document.getElementById('departmentFilter')?.value || '';
                const gender = document.getElementById('GenderFilter')?.value || '';
                const tenureVal = document.getElementById('TenuresFilter')?.value;
                const ageVal = document.getElementById('AgesFilter')?.value;

                const payload = {
                    location: location,
                    department: department,
                    gender: gender,
                    tenure: tenureVal ? parseFloat(tenureVal) : null,
                    age: ageVal ? parseInt(ageVal, 10) : null
                };

                try {
                    const resp = await fetch('/Dashboard/GetFilteredHeatMapData', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) {
                        console.error('Server returned', resp.status);
                        alert('Failed to fetch filtered heatmap data.');
                        return;
                    }

                    const data = await resp.json();
                    // If server returns model object, update both table and top driver cards.
                    // server returns { correlationData: [...], topDiscretionaryEffortDrivers: [...], ... }
                    const correlation = data.correlationData || data.CorrelationData || data;
                    renderHeatmapTable(correlation);

                    updateTopDriverCards(data);
                        hideLoader();


                } catch (err) {
                    console.error(err);
                    alert('An error occurred while fetching heatmap data.');
                } finally {
                    if (submitBtn) submitBtn.disabled = false;
                }
            });
        })();
    </script>
}