@using System.Text.Json
@model TechnicalAssessmentTask2.Models.CommentsReportViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Comments Report";
}

<div class="container-fluid px-4 py-3">
    <!-- Page Title -->
    <h2 class="mb-4 fw-bold">Comments Report</h2>

    <!-- Filters -->
    <div class="card p-3 mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Location</label>
                <select class="form-select form-select-sm" name="location" id="locationFilter">
                    <option value="">All Locations</option>
                    @foreach (var location in Model.Locations)
                    {
                        <option value="@location">@location</option>
                    }
                </select>
            </div>
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Department</label>
                <select class="form-select form-select-sm" name="department" id="departmentFilter">
                    <option value="">All Departments</option>
                    @foreach (var department in Model.Departments)
                    {
                        <option value="@department">@department</option>
                    }
                </select>
            </div>
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Gender</label>
                <select class="form-select form-select-sm" name="Gender" id="GenderFilter">
                    <option value="">All Gender</option>
                    @foreach (var gender in Model.Genders)
                    {
                        <option value="@gender">@gender</option>
                    }
                </select>
            </div>
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Tenure</label>
                <select class="form-select form-select-sm" name="Tenure" id="TenuresFilter">
                    <option value="">All Tenure</option>
                    @foreach (var tenure in Model.Tenures)
                    {
                        <option value="@tenure.Value">@tenure.Text</option>
                    }
                </select>
            </div>
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Age</label>
                <select class="form-select form-select-sm" name="Age" id="AgesFilter">
                    <option value="">All Ages</option>
                    @foreach (var age in Model.Ages)
                    {
                        <option value="@age.Value">@age.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-auto d-flex gap-2">
                <button class="btn btn-primary px-4" id="applyFiltersBtn" style="background-color: #7c3aed; border-color: #7c3aed;">Apply Filters</button>
                <button class="btn btn-outline-secondary">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card p-4 h-100">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="kpi-label">Total Comments</div>
                    <i class="bi bi-chat-dots fs-4" style="color: #7c3aed;"></i>
                </div>
                <div class="kpi-value mb-2" id="TotalComments">@Model.TotalComments</div>
                <small class="text-positive fw-semibold">↑ 12% vs last cycle</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4 h-100">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="kpi-label">Positive Sentiment</div>
                    <i class="bi bi-hand-thumbs-up fs-4 text-success"></i>
                </div>
                <div class="kpi-value text-success mb-2" id="Positive">@Model.Positive%</div>
                <small class="text-positive fw-semibold">↑ 5% vs last cycle</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4 h-100">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="kpi-label">Negative Sentiment</div>
                    <i class="bi bi-hand-thumbs-down fs-4 text-danger"></i>
                </div>
                <div class="kpi-value text-danger mb-2" id="Negative">@Model.Negative%</div>
                <small class="text-negative fw-semibold">↓ 2% vs last cycle</small>
            </div>
        </div>
    </div>

    <!-- Sentiment Word Cloud -->
    <div class="row g-4 mb-4">
        <div class="col-8">
            <div class="card p-4">
                <h6 class="fw-semibold mb-3">Sentiment Word Cloud</h6>
                <div class="word-cloud-container">
                    <canvas id="word-cloud-canvas" width="900" height="500"></canvas>
                    <div id="word-cloud-canvas-hover-box" hidden></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-semibold mb-0">Recent Comments</h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="commentFilter" id="filterAll" checked>
                        <label class="btn btn-outline-secondary" for="filterAll">all</label>
                        <input type="radio" class="btn-check" name="commentFilter" id="filterPositive">
                        <label class="btn btn-outline-secondary" for="filterPositive">positive</label>
                        <input type="radio" class="btn-check" name="commentFilter" id="filterNegative">
                        <label class="btn btn-outline-secondary" for="filterNegative">negative</label>
                    </div>
                </div>

                <!-- initial server-rendered comments kept inside a container for client re-render -->
                <div id="recent-comments-list">
                
                </div>

                <div class="text-end mt-3">
                    <a href="#" class="text-decoration-none small">View More →</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Overview and Recent Comments -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card p-4">

                <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                    <h3 class="text-base font-semibold text-gray-900 mb-1">Theme Overview</h3>
                    <p class="text-sm text-gray-500 mb-6">Visualizing the relationship and volume of top discussion themes.</p>
                    <div class="h-72 relative">
                        <svg width="100%" height="100%" viewBox="0 0 700 280" preserveAspectRatio="xMidYMid meet" style="font-family: Inter, &quot;Exo 2&quot;, sans-serif;">
                            <ellipse cx="115" cy="130" rx="85" ry="80" fill="rgba(254, 202, 202, 0.5)" stroke="rgba(252, 165, 165, 0.8)" stroke-width="1"></ellipse>
                            <text x="115" y="135" text-anchor="middle" font-size="14" font-weight="600" fill="#374151">WorkLoad</text>
                            <ellipse cx="75" cy="225" rx="45" ry="38" fill="rgba(229, 231, 235, 0.6)" stroke="rgba(209, 213, 219, 0.8)" stroke-width="1"></ellipse>
                            <text x="75" y="220" text-anchor="middle" font-size="10" font-weight="500" fill="#374151">Tools &amp;</text>
                            <text x="75" y="233" text-anchor="middle" font-size="10" font-weight="500" fill="#374151">Resources</text>
                            <ellipse cx="175" cy="210" rx="60" ry="50" fill="rgba(254, 202, 202, 0.5)" stroke="rgba(252, 165, 165, 0.8)" stroke-width="1"></ellipse>
                            <text x="175" y="215" text-anchor="middle" font-size="11" font-weight="500" fill="#374151">Work-Life Balance</text>
                            <ellipse cx="300" cy="90" rx="65" ry="60" fill="rgba(254, 202, 202, 0.5)" stroke="rgba(252, 165, 165, 0.8)" stroke-width="1"></ellipse>
                            <text x="300" y="95" text-anchor="middle" font-size="13" font-weight="600" fill="#374151">Compensation</text>
                            <ellipse cx="340" cy="200" rx="45" ry="40" fill="rgba(199, 210, 254, 0.5)" stroke="rgba(165, 180, 252, 0.8)" stroke-width="1"></ellipse>
                            <text x="340" y="195" text-anchor="middle" font-size="10" font-weight="500" fill="#374151">Career</text>
                            <text x="340" y="208" text-anchor="middle" font-size="10" font-weight="500" fill="#374151">Growth</text>
                            <ellipse cx="415" cy="195" rx="42" ry="38" fill="rgba(254, 202, 202, 0.5)" stroke="rgba(252, 165, 165, 0.8)" stroke-width="1"></ellipse>
                            <text x="415" y="200" text-anchor="middle" font-size="11" font-weight="500" fill="#374151">Rewards</text>
                            <ellipse cx="480" cy="85" rx="55" ry="50" fill="rgba(229, 231, 235, 0.6)" stroke="rgba(209, 213, 219, 0.8)" stroke-width="1"></ellipse>
                            <text x="480" y="80" text-anchor="middle" font-size="10" font-weight="500" fill="#374151">Sense of</text>
                            <text x="480" y="93" text-anchor="middle" font-size="10" font-weight="500" fill="#374151">Belonging</text>
                            <ellipse cx="590" cy="120" rx="80" ry="75" fill="rgba(199, 210, 254, 0.45)" stroke="rgba(165, 180, 252, 0.8)" stroke-width="1"></ellipse>
                            <text x="590" y="125" text-anchor="middle" font-size="14" font-weight="600" fill="#374151">Leadership</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
@section Scripts {

    <script type="text/javascript">
        let currentWords = @Html.Raw(JsonSerializer.Serialize(ViewBag.WordCloudData));
        let recentComments = @Html.Raw(JsonSerializer.Serialize(Model.RecentComments ?? new List<RecentComment>()));

        const escapeHtml = (str) => {
            if (!str && str !== 0) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        };

        function renderRecentComments(filter = 'all') {
            const container = document.getElementById('recent-comments-list');

            if (!container) return;
            container.innerHTML = '';

            const list = Array.isArray(recentComments) ? recentComments : [];
            const filtered = list.filter(c => {
                const positive = (c.positive ?? c.Positive) === true;
                if (filter === 'positive') return positive;
                if (filter === 'negative') return !positive;
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-muted small">No comments available for the selected filter.</div>';
                return;
            }

            // render at most 4 comments
            const toShow = filtered.slice(0, 4);
            toShow.forEach(c => {
                const positive = (c.positive ?? c.Positive) === true;
                const commentText = c.commentText ?? c.CommentText ?? '';
                const supporting = c.supportingInfo ?? c.SupportingInfo ?? '';

                const card = document.createElement('div');
                card.className = 'comment-card mb-3 ' + (positive ? 'positive' : 'negative');

                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="badge ${positive ? 'bg-success PositiveComment' : 'bg-danger NegativeComment'}">${positive ? 'Positive' : 'Negative'}</small>
                        <small class="text-muted">2 days ago</small>
                    </div>
                    <p class="mb-2 small">"${escapeHtml(commentText)}"</p>
                    <span class="badge bg-light text-dark small">${escapeHtml(supporting)}</span>
                `;
                container.appendChild(card);
            });
        }

        // initial render of recent comments (server-provided)
        renderRecentComments('all');

        const drawWordCloud = (words) => {
            if (WordCloud.isSupported) {
                const wordCloudCanvas = document.getElementById('word-cloud-canvas');
                const wordCloudCanvasHoverBox = document.getElementById('word-cloud-canvas-hover-box');
                const elements = [wordCloudCanvas];
                const originalWords = words.map(x => ({ word: x[0], count: x[1] }));

                const options = {
                    list: words,
                    gridSize: 12,
                    fontFamily: "Segoe UI",
                    color: function (word, weight, fontSize, distance, theta) {
                        const colors = ["#800080", "#000000", "#FF0000"]; // purple, black, red
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    rotateRatio: 0,
                    rotationSteps: 1,
                    backgroundColor: "#ffffff",
                    drawOutOfBound: false,
                    shrinkToFit: false
                };

                WordCloud(elements, options);

                // Add click handler after word cloud is drawn
                wordCloudCanvas.addEventListener('wordcloudstop', function (e) {
                    document.querySelectorAll('.word-cloud-item').forEach(function (element) {
                        element.addEventListener('click', event => {
                            const originalItem = originalWords.find(x => x.word === element.textContent);
                            if (originalItem) {
                                alert(`${originalItem.word}: ${originalItem.count}`);
                            }
                        });
                    });
                });
            } else {
                console.log('WordCloud not supported');
            }
        };

        const applyFilters = async () => {
            const location = document.getElementById('locationFilter').value;
            const department = document.getElementById('departmentFilter').value;
            const gender = document.getElementById('GenderFilter').value;
            const tenure = document.getElementById('TenuresFilter').value;
            const age = document.getElementById('AgesFilter').value;

            try {
                const response = await fetch('/Dashboard/GetFilteredWordCloudData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        location: location || '',
                        department: department || '',
                        gender: gender || '',
                        tenure: tenure ? parseFloat(tenure) : null,
                        age: age ? parseInt(age) : null
                    })
                });

                if (response.ok) {
                    const data = await response.json();

                    // update KPIs (use both jQuery and DOM to be resilient)
                    const total = data.totalComments ?? data.TotalComments ?? 0;
                    const positive = data.positive ?? data.Positive ?? 0;
                    const negative = data.negative ?? data.Negative ?? 0;
                    const wordCloud = data.wordCloud ?? data.WordCloud ?? [];

                    document.getElementById('TotalComments').textContent = total;
                    const posEl = document.getElementById('Positive');
                    if (posEl) posEl.textContent = positive;
                    const negEl = document.getElementById('Negative');
                    if (negEl) negEl.textContent = negative;

                    // update in-memory recentComments and re-render comment cards
                    recentComments = data.recentComments ?? data.RecentComments ?? [];

                    // determine which radio is selected
                    const selected = document.querySelector('input[name="commentFilter"]:checked')?.id || 'filterAll';
                    const currentFilter = selected === 'filterPositive' ? 'positive' : selected === 'filterNegative' ? 'negative' : 'all';
                    renderRecentComments(currentFilter);

                    // update word cloud
                    if (!Array.isArray(wordCloud) || wordCloud.length === 0) {
                        // no word cloud entries
                        currentWords = [];
                        const canvas = document.getElementById('word-cloud-canvas');
                        if (canvas) {
                            canvas.width = 900; canvas.height = 500;
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0,0,canvas.width, canvas.height);
                        }
                    } else {
                        currentWords = wordCloud;
                        // Reset the canvas completely
                        const canvas = document.getElementById('word-cloud-canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 900;
                        canvas.height = 500;
                        ctx.fillStyle = "#ffffff";
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        drawWordCloud(currentWords);
                    }
                } else {
                    console.error('Failed to fetch filtered data');
                    alert('Failed to apply filters. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while applying filters.');
            }
        };

        // Attach event listener to apply filters button
        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);

        // radio buttons: filter currently rendered comments client-side
        document.getElementById('filterAll').addEventListener('change', () => renderRecentComments('all'));
        document.getElementById('filterPositive').addEventListener('change', () => renderRecentComments('positive'));
        document.getElementById('filterNegative').addEventListener('change', () => renderRecentComments('negative'));

        // Draw initial word cloud
        drawWordCloud(currentWords);
    </script>
}