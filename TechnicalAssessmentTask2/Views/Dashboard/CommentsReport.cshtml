@using System.Text.Json
@model TechnicalAssessmentTask2.Models.CommentsReportViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Comments Report";
}

<div class="container-fluid px-4 py-3">
    <!-- Page Title -->
    <h2 class="mb-4 fw-bold">Comments Report</h2>

    <!-- Filters -->
    <div class="card p-3 mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Location</label>
                <select class="form-select form-select-sm" name="location" id="locationFilter">
                    <option value="">All Locations</option>
                    @foreach (var location in Model.Locations)
                    {
                        <option value="@location">@location</option>
                    }
                </select>
            </div>
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Department</label>
                <select class="form-select form-select-sm" name="department" id="departmentFilter">
                    <option value="">All Departments</option>
                    @foreach (var department in Model.Departments)
                    {
                        <option value="@department">@department</option>
                    }
                </select>
            </div>
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Gender</label>
                <select class="form-select form-select-sm" name="Gender" id="GenderFilter">
                    <option value="">All Gender</option>
                    @foreach (var gender in Model.Genders)
                    {
                        <option value="@gender">@gender</option>
                    }
                </select>
            </div>
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Tenure</label>
                <select class="form-select form-select-sm" name="Tenure" id="TenuresFilter">
                    <option value="">All Tenure</option>
                    @foreach (var tenure in Model.Tenures)
                    {
                        <option value="@tenure.Value">@tenure.Text</option>
                    }
                </select>
            </div>
            <div class="col-md">
                <label class="form-label small text-muted mb-1">Age</label>
                <select class="form-select form-select-sm" name="Age" id="AgesFilter">
                    <option value="">All Ages</option>
                    @foreach (var age in Model.Ages)
                    {
                        <option value="@age.Value">@age.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-auto d-flex gap-2">
                <button class="btn btn-primary px-4" id="applyFiltersBtn" style="background-color: #7c3aed; border-color: #7c3aed;">Apply Filters</button>
                <button class="btn btn-outline-secondary">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card p-4 h-100">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="kpi-label">Total Comments</div>
                    <i class="bi bi-chat-dots fs-4" style="color: #7c3aed;"></i>
                </div>
                <div class="kpi-value mb-2">1,248</div>
                <small class="text-positive fw-semibold">↑ 12% vs last cycle</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4 h-100">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="kpi-label">Positive Sentiment</div>
                    <i class="bi bi-hand-thumbs-up fs-4 text-success"></i>
                </div>
                <div class="kpi-value text-success mb-2">64%</div>
                <small class="text-positive fw-semibold">↑ 5% vs last cycle</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4 h-100">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="kpi-label">Negative Sentiment</div>
                    <i class="bi bi-hand-thumbs-down fs-4 text-danger"></i>
                </div>
                <div class="kpi-value text-danger mb-2">14%</div>
                <small class="text-negative fw-semibold">↓ 2% vs last cycle</small>
            </div>
        </div>
    </div>

    <!-- Sentiment Word Cloud -->
    <div class="row g-4 mb-4">
        <div class="col-8">
            <div class="card p-4">
                <h6 class="fw-semibold mb-3">Sentiment Word Cloud</h6>
                <div class="word-cloud-container">
                    <canvas id="word-cloud-canvas" width="900" height="500"></canvas>
                    <div id="word-cloud-canvas-hover-box" hidden></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-semibold mb-0">Recent Comments</h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="commentFilter" id="filterAll" checked>
                        <label class="btn btn-outline-secondary" for="filterAll">all</label>
                        <input type="radio" class="btn-check" name="commentFilter" id="filterPositive">
                        <label class="btn btn-outline-secondary" for="filterPositive">positive</label>
                        <input type="radio" class="btn-check" name="commentFilter" id="filterNegative">
                        <label class="btn btn-outline-secondary" for="filterNegative">negative</label>
                    </div>
                </div>

                <div class="comment-card positive mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="badge bg-success">Positive</small>
                        <small class="text-muted">2 days ago</small>
                    </div>
                    <p class="mb-2 small">"I really appreciate the flexibility with remote work options. It has significantly improved my work-life balance and overall productivity."</p>
                    <span class="badge bg-light text-dark small">Work Life Balance</span>
                </div>

                <div class="comment-card negative mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="badge bg-danger">Negative</small>
                        <small class="text-muted">1 week ago</small>
                    </div>
                    <p class="mb-2 small">"Salary adjustments this year didn't seem to match the inflation rate. A lot of the team is concerned about compensation competitiveness."</p>
                    <span class="badge bg-light text-dark small">Rewards</span>
                </div>

                <div class="comment-card negative mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="badge bg-danger">Negative</small>
                        <small class="text-muted">3 days ago</small>
                    </div>
                    <p class="mb-2 small">"The new project management tool is quite confusing and slows us down. We need better training or a more intuitive system."</p>
                    <span class="badge bg-light text-dark small">Enablement</span>
                </div>

                <div class="comment-card neutral">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="badge bg-secondary">Neutral</small>
                        <small class="text-muted">1 week ago</small>
                    </div>
                    <p class="mb-2 small">"The cross-functional collaboration between marketing and engineering has improved, but there are still silos."</p>
                    <span class="badge bg-light text-dark small">Collaboration</span>
                </div>

                <div class="text-end mt-3">
                    <a href="#" class="text-decoration-none small">View More →</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Overview and Recent Comments -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card p-4">
                <h6 class="fw-semibold mb-2">Theme Overview</h6>
                <p class="small text-muted mb-3">Visualizing the relationship and volume of top discussion themes.</p>
                <div id="bubble-container" style="display: flex; flex-wrap: wrap; gap: 10px; max-width: 900px;"></div>

               @*  <div class="theme-bubble-chart">
                    <svg viewBox="0 0 600 400" class="bubble-svg">
                        <!-- WorkLoad, Work-Life Balance, Tools & Resources (red, overlapping) -->
                        <circle cx="200" cy="150" r="60" fill="#ef4444" opacity="0.7" />
                        <circle cx="230" cy="170" r="55" fill="#ef4444" opacity="0.7" />
                        <circle cx="210" cy="190" r="50" fill="#ef4444" opacity="0.7" />
                        <text x="200" y="150" text-anchor="middle" class="bubble-label">WorkLoad</text>
                        <text x="230" y="170" text-anchor="middle" class="bubble-label">Work-Life Balance</text>
                        <text x="210" y="190" text-anchor="middle" class="bubble-label">Tools & Resources</text>

                        <!-- Compensation (red, separate) -->
                        <circle cx="400" cy="100" r="45" fill="#ef4444" opacity="0.7" />
                        <text x="400" y="100" text-anchor="middle" class="bubble-label">Compensation</text>

                        <!-- Career Growth and Rewards (blue and red, overlapping) -->
                        <circle cx="350" cy="250" r="55" fill="#3b82f6" opacity="0.7" />
                        <circle cx="380" cy="270" r="50" fill="#ef4444" opacity="0.7" />
                        <text x="350" y="250" text-anchor="middle" class="bubble-label">Career Growth</text>
                        <text x="380" y="270" text-anchor="middle" class="bubble-label">Rewards</text>

                        <!-- Sense of Belonging and Leadership (blue, overlapping) -->
                        <circle cx="150" cy="300" r="50" fill="#3b82f6" opacity="0.7" />
                        <circle cx="180" cy="320" r="55" fill="#3b82f6" opacity="0.7" />
                        <text x="150" y="300" text-anchor="middle" class="bubble-label">Sense of Belonging</text>
                        <text x="180" y="320" text-anchor="middle" class="bubble-label">Leadership</text>
                    </svg>
                </div> *@
            </div>
        </div>

    </div>
</div>
@section Scripts {

    <script type="text/javascript">
        let currentWords = @Html.Raw(JsonSerializer.Serialize(ViewBag.WordCloudData));

        const drawWordCloud = (words) => {
            if (WordCloud.isSupported) {
                const wordCloudCanvas = document.getElementById('word-cloud-canvas');
                const wordCloudCanvasHoverBox = document.getElementById('word-cloud-canvas-hover-box');
                const elements = [wordCloudCanvas];
                const originalWords = words.map(x => ({ word: x[0], count: x[1] }));

                const options = {
                    list: words,
                    gridSize: 12,
                  

                    fontFamily: "Segoe UI",
                    color: function (word, weight, fontSize, distance, theta) {
                        const colors = ["#800080", "#000000", "#FF0000"]; // purple, black, red
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    rotateRatio: 0,
                    rotationSteps: 1,
                    backgroundColor: "#ffffff",
                    drawOutOfBound: false,
                    shrinkToFit: false
                };

                WordCloud(elements, options);

                // Add click handler after word cloud is drawn
                wordCloudCanvas.addEventListener('wordcloudstop', function (e) {
                    document.querySelectorAll('.word-cloud-item').forEach(function (element) {
                        element.addEventListener('click', event => {
                            const originalItem = originalWords.find(x => x.word === element.textContent);
                            if (originalItem) {
                                alert(`${originalItem.word}: ${originalItem.count}`);
                            }
                        });
                    });
                });
            } else {
                console.log('WordCloud not supported');
            }
        };

        const applyFilters = async () => {
            const location = document.getElementById('locationFilter').value;
            const department = document.getElementById('departmentFilter').value;
            const gender = document.getElementById('GenderFilter').value;
            const tenure = document.getElementById('TenuresFilter').value;
            const age = document.getElementById('AgesFilter').value;

            try {
                const response = await fetch('/Dashboard/GetFilteredWordCloudData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        location: location || '',
                        department: department || '',
                        gender: gender || '',
                        tenure: tenure ? parseFloat(tenure) : null,
                        age: age ? parseInt(age) : null
                    })
                });

                if (response.ok) {
                    const data = await response.json();

                    if (data.length === 0) {
                        alert('No data found for the selected filters.');
                        return;
                    }

                    currentWords = data;

                    // Reset the canvas completely
                    const canvas = document.getElementById('word-cloud-canvas');
                    const ctx = canvas.getContext('2d');

                    // Reset canvas size to force re-render
                    canvas.width = 900;
                    canvas.height = 500;

                    // Clear the canvas
                    ctx.fillStyle = "#ffffff";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Redraw the word cloud with filtered data
                    drawWordCloud(data);
                } else {
                    console.error('Failed to fetch filtered data');
                    alert('Failed to apply filters. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while applying filters.');
            }
        };

        // Attach event listener to apply filters button
        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);

        // Draw initial word cloud
        drawWordCloud(currentWords);





              // Example data: list of [word, count]
        const Bubblewords = [
          ["Flexibility", 10],
          ["Culture", 7],
          ["Communication", 15],
          ["Goals", 5],
          ["Management", 12],
          ["Recognition", 3]
        ];

        const container = document.getElementById('bubble-container');

        // Normalize sizes for bubbles (min 30px to max 150px)
        const counts = Bubblewords .map(w => w[1]);
        const minCount = Math.min(...counts);
        const maxCount = Math.max(...counts);

        function normalize(count) {
          const minSize = 30;
          const maxSize = 150;
          return minSize + ((count - minCount) / (maxCount - minCount)) * (maxSize - minSize);
        }

        Bubblewords .forEach(([word, count]) => {
          const size = normalize(count);

          // Create bubble div
          const bubble = document.createElement('div');
          bubble.textContent = word + ' (' + count + ')';
          bubble.style.width = size + 'px';
          bubble.style.height = size + 'px';
          bubble.style.borderRadius = '50%';
          bubble.style.backgroundColor = '#6c5ce7';
          bubble.style.color = 'white';
          bubble.style.display = 'flex';
          bubble.style.alignItems = 'center';
          bubble.style.justifyContent = 'center';
          bubble.style.fontSize = Math.min(14, size / 5) + 'px';
          bubble.style.cursor = 'default';
          bubble.style.userSelect = 'none';

          container.appendChild(bubble);
        });
    </script>
}